# Formbook

## [formbook_decrypt_hash_string.py](formbook_decrypt_hash_string.py)

### Description

This script is based on IDA Python API. It is used to:

  * Decrypt a BZip2 CRC32 hashes array ([func_index_hashes.txt](func_index_hashes.txt)) and try to match these hashes against:
     * Function name and DLLs name used to perform dynamic import resolution
     * Blacklisted PE image names of processes commonly used by malware analyst (wireshark, procmon, ...)
     * Blacklisted directory names (anti-sandbox)
     * Blacklisted usernames (anti-sandbox)
     * PE image names of processes targeted by formbook (for key-logging or form-grabbing)
  * Decrypt strings used by formbook ([decrypted_strings.txt](decrypted_strings.txt))
  * Decrypt PE image names ([decrypted_image_name.txt](decrypted_image_name.txt)) of windows processes targeted by process hollowing
  * Decrypt the C&C URI used to perform network communications
  * Patch IDA database by decrypting the instructions of several encrypted functions
  * Identify functions dynamically imported, using plain BZip2 CRC32 hashes ([plain_hashes.txt](plain_hashes.txt))

Please note that this script is intended to work with [this specific sample](https://www.virustotal.com/fr/file/d250cfc9ded9585982074ccfe1825d62a415907c31007bcc3d5305af089b7716/analysis/), as it contains several hard-coded addresses.

### Usage

This script uses [shellcode_hashes](https://github.com/fireeye/flare-ida/tree/master/shellcode_hashes) plugin to find functions dynamically imported. Thus, the SQLite database of function name hashes must first be generated, with the support of Crc32Bzip2 added to make_sc_hash_db.py:
```python
from crccheck.crc import Crc32Bzip2

def bzip2_crc32(inString, fName):
    return Crc32Bzip2.calc(bytearray(inString.lower()))
```

## [formbook_decode_pcap.py](formbook_decode_pcap.py)

### Description

This script is used to decode formbook's communications. It extracts the following type of data, sent over HTTP to the C&C server:
  * Beaconing requests
  * Intercepted HTML forms
  * Keystrokes
  * Password Recoveries
  * Clipboard data
  * Screenshot

> This script has been tested with formbook version 3.8 and 3.9. The way formbook encode its data changes regularly according to newer releases. Thus, please be aware that it might not work with future releases.

### Installation
```
python3 -m venv ./venv
source ./venv/bin/activate
pip install pyshark==0.4.1 dpkt==1.9.1 pycrypto==2.6.1
```

### Example

```
{
    "pkt_number": 18213,
    "http_request": true,
    "http_method": "POST",
    "http_host": "www.wiciyuwi37.download",
    "uri_base": "www.wiciyuwi37.download/on/",
    "keylog_sniff_recoveries": {
        "username": "administrator",
        "br_id": 9,
        "payload": "\r\nFirefox Recovery\r\n\r\nURL: https://www.facebook.com\r\nUsername: john.smith@gmail.com\r\nPassword: johonsmith42\r\n"
    }
}
{
    "pkt_number": 18576,
    "http_request": true,
    "http_method": "GET",
    "http_host": "www.wiciyuwi37.download",
    "uri_base": "www.wiciyuwi37.download/on/",
    "beaconing": {
        "username": "administrator",
        "sid_crc": "C1EACBB4",
        "version": "3.9",
        "windows_version": "Windows 7 Enterprise x64"
    }
}
{
    "pkt_number": 19257,
    "http_request": true,
    "http_method": "POST",
    "http_host": "www.wiciyuwi37.download",
    "uri_base": "www.wiciyuwi37.download/on/",
    "screenshot": {
        "username": "administrator",
        "br_id": 8,
        "sid_crc": "C1EACBB4",
        "screen_path": "dump/fb_screen_19257.jpeg"
    }
}
{
    "pkt_number": 20229,
    "http_request": true,
    "http_method": "POST",
    "http_host": "www.wiciyuwi37.download",
    "uri_base": "www.wiciyuwi37.download/on/",
    "form": {
        "un": "administrator",
        "br_id": 2,
        "browser": "Chrome",
        "payload_utf8": "POST /cgi-bin/echo.cgi HTTP/1.1\r\nHost: jkorpela.fi\r\nConnection: keep-alive\r\nContent-Length: 101\r\nCache-Control: max-age=0\r\nOrigin: http://jkorpela.fi\r\nUpgrade-Insecure-Requests: 1\r\nContent-Type: application/x-www-form-urlencoded\r\nUser-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36\r\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8\r\nReferer: http://jkorpela.fi/forms/testing.html\r\nAccept-Encoding: gzip, deflate\r\nAccept-Language: fr-FR,fr;q=0.9,en-US;q=0.8,en;q=0.7\r\nCookie: SERVERID=web2-3\r\n\r\nComments=pass%3Dfakepassword%0D%0Apass%3Dfakepassword%0D%0Apass%3Dfakepassword&hidden+field=something",
        "payload_b64": "UE9TVCAvY2dpLWJpbi9lY2hvLmNnaSBIVFRQLzEuMQ0KSG9zdDogamtvcnBlbGEuZmkNCkNvbm5lY3Rpb246IGtlZXAtYWxpdmUNCkNvbnRlbnQtTGVuZ3RoOiAxMDENCkNhY2hlLUNvbnRyb2w6IG1heC1hZ2U9MA0KT3JpZ2luOiBodHRwOi8vamtvcnBlbGEuZmkNClVwZ3JhZGUtSW5zZWN1cmUtUmVxdWVzdHM6IDENCkNvbnRlbnQtVHlwZTogYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkDQpVc2VyLUFnZW50OiBNb3ppbGxhLzUuMCAoV2luZG93cyBOVCA2LjE7IFdpbjY0OyB4NjQpIEFwcGxlV2ViS2l0LzUzNy4zNiAoS0hUTUwsIGxpa2UgR2Vja28pIENocm9tZS82OS4wLjM0OTcuMTAwIFNhZmFyaS81MzcuMzYNCkFjY2VwdDogdGV4dC9odG1sLGFwcGxpY2F0aW9uL3hodG1sK3htbCxhcHBsaWNhdGlvbi94bWw7cT0wLjksaW1hZ2Uvd2VicCxpbWFnZS9hcG5nLCovKjtxPTAuOA0KUmVmZXJlcjogaHR0cDovL2prb3JwZWxhLmZpL2Zvcm1zL3Rlc3RpbmcuaHRtbA0KQWNjZXB0LUVuY29kaW5nOiBnemlwLCBkZWZsYXRlDQpBY2NlcHQtTGFuZ3VhZ2U6IGZyLUZSLGZyO3E9MC45LGVuLVVTO3E9MC44LGVuO3E9MC43DQpDb29raWU6IFNFUlZFUklEPXdlYjItMw0KDQpDb21tZW50cz1wYXNzJTNEZmFrZXBhc3N3b3JkJTBEJTBBcGFzcyUzRGZha2VwYXNzd29yZCUwRCUwQXBhc3MlM0RmYWtlcGFzc3dvcmQmaGlkZGVuK2ZpZWxkPXNvbWV0aGluZw=="
    }
}

```
## Misc

### [floss_stackstrings.txt](floss_stackstrings.txt)

This file contains Floss FireEye's plugin output, the recovery of stackstrings used abundantly by formbook.
